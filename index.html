
<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>GeoParcele – Firme & Navigație</title>
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#111827" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root { --bg:#f6f7f8; --ink:#111827; --line:#e5e7eb; --brand:#111827; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--ink); }
    header { position:fixed; top:0; left:0; right:0; height:56px; background:var(--brand); color:#fff; display:flex; align-items:center; gap:8px; padding:0 10px; z-index:50; }
    #hamburger { width:36px; height:36px; border-radius:10px; border:1px solid #374151; background:#1f2937; color:#fff; }
    header .btn, header label.btn { background:#fff; color:#111; border:1px solid var(--line); padding:8px 10px; border-radius:10px; font-size:14px; }
    header input[type=file]{ display:none; }
    #app { position:fixed; top:56px; bottom:0; left:0; right:0; }
    #sidebar { position:absolute; top:0; bottom:0; left:0; width:320px; max-width:92vw; background:#fff; border-right:1px solid var(--line); box-shadow: 0 10px 30px rgba(0,0,0,.12); transform: translateX(-100%); transition: transform .25s ease; z-index:40; }
    #sidebar.open { transform: translateX(0); }
    #sidebar .section { border-bottom:1px solid var(--line); padding:10px; }
    #sidebar h3 { margin:0 0 6px; font-size:14px; }
    #map { position:absolute; inset:0; }
    .fab { position:absolute; right:12px; bottom:12px; display:flex; flex-direction:column; gap:10px; z-index:45; }
    .fab button { width:54px; height:54px; border-radius:999px; border:none; background:#111827; color:#fff; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; border:1px solid #e5e7eb; background:#f9fafb; font-size:12px; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 0; border-bottom:1px dashed #f0f0f0; }
    .row:last-child { border-bottom:none; }
    .muted { color:#6b7280; font-size:12px; }
    .tiny { font-size:12px; }
    .btn { background:#fff; border:1px solid #e5e7eb; padding:6px 8px; border-radius:8px; }
  </style>
</head>
<body>
  <header>
    <button id="hamburger">☰</button>
    <strong>GeoParcele</strong>
    <label class="btn">Import GeoJSON <input id="file" type="file" accept="application/geo+json,application/json,.geojson,.json" /></label>
    <button id="export" class="btn">Export</button>
    <input id="search" placeholder="Caută parcelă…" style="flex:1; min-width:180px; padding:8px 10px; border:1px solid var(--line); border-radius:10px;">
    <button id="install" class="btn">Instalează</button>
  </header>

  <div id="app">
    <aside id="sidebar">
      <div class="section">
        <h3>Firme (categorii)</h3>
        <div id="firmList"></div>
      </div>
      <div class="section">
        <h3>Parcele</h3>
        <div id="parcelList" style="max-height:40vh; overflow:auto;"></div>
      </div>
      <div class="section">
        <div class="muted tiny">Sfat: poți selecta o firmă, apoi Import → adaugă toate noile parcele direct la acea firmă.</div>
      </div>
    </aside>
    <div id="map"></div>
    <div class="fab">
      <button id="locate" title="Arată poziția mea">GPS</button>
      <button id="follow" title="Urmărește-mă">▶︎</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <script src="/sw-register.js"></script>
  <script>
    // PWA install
    let deferredPrompt=null;
    window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault(); deferredPrompt=e;});
    document.getElementById('install').addEventListener('click', async ()=>{
      if(deferredPrompt){ deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; }
      else alert('Android: ⋮ → Add to Home screen. iPhone: Share → Add to Home Screen.');
    });

    // Hide/Show menu
    const sidebar = document.getElementById('sidebar');
    document.getElementById('hamburger').onclick = () => { sidebar.classList.toggle('open'); };

    // Storage
    const LS_FEATURES='geoparcele@features@v4';
    const LS_FIRM='geoparcele@firmFilter@v4';
    let features = load(LS_FEATURES) || [];
    let firmFilter = load(LS_FIRM) || null;
    const FIRMS = ['Keresztes Emese', 'Agroarn', 'Agrobaza'];
    const FIRM_COLORS = {
      'Keresztes Emese': '#ef4444', // roșu
      'Agroarn': '#2563eb', // albastru
      'Agrobaza': '#f59e0b' // portocaliu
    };

    function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
    function load(k){ try{ return JSON.parse(localStorage.getItem(k)||'null'); }catch{return null;} }

    // Map
    let map = L.map('map').setView([47.1585, 23.5681], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

    let meMarker=null, accCircle=null, follow=false;
    function updateMe(lat,lng,acc){
      const p=[lat,lng];
      if(!meMarker){ meMarker=L.marker(p).addTo(map).bindPopup('Tu ești aici'); }
      else meMarker.setLatLng(p);
      if(acc>0){
        if(!accCircle){ accCircle=L.circle(p,{radius:acc, color:'#6b7280'}).addTo(map); }
        else { accCircle.setLatLng(p); accCircle.setRadius(acc); }
      }
      if(follow){ map.setView(p, Math.max(map.getZoom(), 16)); }
    }
    if('geolocation' in navigator){
      navigator.geolocation.watchPosition((pos)=>{
        updateMe(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy||0);
      }, ()=>{}, { enableHighAccuracy:true, maximumAge:3000, timeout:10000 });
    }
    document.getElementById('locate').onclick=()=>{ if(meMarker){ map.setView(meMarker.getLatLng(), 16); } };
    document.getElementById('follow').onclick=()=>{ follow=!follow; document.getElementById('follow').textContent = follow ? '⏸' : '▶︎'; };

    function drawMap(){
      // clear non-tile & keep me layers
      map.eachLayer(l => { if(!(l instanceof L.TileLayer) && l!==meMarker && l!==accCircle) map.removeLayer(l); });
      const vis = getVisibleFeatures();
      for(const f of vis){
        const color = FIRM_COLORS[f.firm] || '#06b6d4';
        const poly = L.polygon(f.coords, { color, weight: 2 }).addTo(map);
        // label (tooltip) inside polygon
        const label = `${escapeHtml(f.name||'Parcelă')} — ${escapeHtml(f.firm||'')} — ${formatHa(areaHa(f))}`;
        poly.bindTooltip(label, { permanent: true, direction: 'center', className: 'parcel-label' });
        poly.bindPopup(makePopupHTML(f));
      }
      if(meMarker) meMarker.bringToFront(); if(accCircle) accCircle.bringToFront();
    }

    function areaHa(f){
      try{
        const coords = [ f.coords[0].map(([lat,lng])=>[lng,lat]) ];
        const gj = { type:'Feature', geometry:{ type:'Polygon', coordinates: coords } };
        const a = turf.area(gj); // m²
        return a/10000;
      }catch(e){ return NaN; }
    }
    function formatHa(x){ return isFinite(x) ? (x.toFixed(2)+' ha') : ''; }

    function makePopupHTML(f){
      const c=centerOf(f.coords);
      const gmaps = `https://www.google.com/maps/dir/?api=1&destination=${c[0]},${c[1]}`;
      return `<div><strong>${escapeHtml(f.name||'Parcelă')}</strong></div>
              <div class="tiny muted">${escapeHtml(f.firm||'')} · ${formatHa(areaHa(f))}</div>
              <div style="margin-top:6px; display:flex; gap:6px;">
                <a href="${gmaps}" target="_blank" class="btn" style="text-decoration:none;">Navighează</a>
                <button onclick="window.focusParcel('${f.id}')" class="btn">Arată</button>
              </div>`;
    }
    window.focusParcel = (id) => { const f=features.find(x=>x.id===id); if(!f) return; map.setView(centerOf(f.coords), 17); };

    function centerOf(coords){
      let sLat=0, sLng=0, n=0;
      coords[0].forEach(([lat,lng])=>{ sLat+=lat; sLng+=lng; n++; });
      return [sLat/n, sLng/n];
    }

    function getVisibleFeatures(){
      const q=document.getElementById('search').value.trim().toLowerCase();
      return features.filter(f => {
        const okName=!q || (f.name||'').toLowerCase().includes(q);
        const okFirm=!firmFilter || f.firm===firmFilter;
        return okName && okFirm;
      });
    }

    // Sidebar
    function renderFirms(){
      const box=document.getElementById('firmList'); box.innerHTML='';
      // All
      const rowAll=document.createElement('div'); rowAll.className='row';
      const allBtn=document.createElement('button'); allBtn.className='btn'; allBtn.textContent='Toate firmele';
      if(!firmFilter) allBtn.style.background='#e5e7eb';
      allBtn.onclick=()=>{ firmFilter=null; save(LS_FIRM, firmFilter); drawMap(); renderParcels(); renderFirms(); };
      rowAll.appendChild(allBtn); box.appendChild(rowAll);
      // Each firm
      for(const firm of FIRMS){
        const row=document.createElement('div'); row.className='row';
        const left=document.createElement('div'); left.innerHTML = `<span class="pill" style="border-color:${FIRM_COLORS[firm]};">${firm}</span>`;
        const right=document.createElement('div');
        const sel=document.createElement('button'); sel.className='btn'; sel.textContent = (firmFilter===firm)?'Selectat':'Selectează';
        sel.onclick=()=>{ firmFilter = (firmFilter===firm?null:firm); save(LS_FIRM, firmFilter); drawMap(); renderParcels(); renderFirms(); };
        right.appendChild(sel);
        row.appendChild(left); row.appendChild(right);
        box.appendChild(row);
      }
    }

    function renderParcels(){
      const box=document.getElementById('parcelList'); box.innerHTML='';
      const items=getVisibleFeatures();
      if(!items.length){ box.innerHTML='<div class="muted">Nu există parcele (încarcă GeoJSON sau schimbă filtrul).</div>'; return; }
      for(const f of items){
        const row=document.createElement('div'); row.className='row';
        const left=document.createElement('div'); left.innerHTML=`<div><strong>${escapeHtml(f.name||'Parcelă')}</strong></div><div class="tiny muted">${escapeHtml(f.firm||'')} · ${formatHa(areaHa(f))}</div>`;
        const right=document.createElement('div');
        const btnFocus=document.createElement('button'); btnFocus.className='btn'; btnFocus.textContent='Arată'; btnFocus.onclick=()=>{ map.setView(centerOf(f.coords), 17); };
        const btnNav=document.createElement('a'); btnNav.className='btn'; btnNav.textContent='GPS'; btnNav.target='_blank'; const c=centerOf(f.coords); btnNav.href=`https://www.google.com/maps/dir/?api=1&destination=${c[0]},${c[1]}`;
        right.appendChild(btnFocus); right.appendChild(btnNav);
        row.appendChild(left); row.appendChild(right);
        box.appendChild(row);
      }
    }

    // Import/Export
    document.getElementById('file').addEventListener('change',(e)=>{
      const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{
        try{
          const gj=JSON.parse(r.result); const feats=(gj.type==='FeatureCollection')?gj.features:(gj.type?[gj]:[]);
          const toAdd=[];
          for(const ft of feats){
            const g=ft.geometry||{}; if(!g||!g.type) continue; let ring=null;
            if(g.type==='Polygon'){ ring=g.coordinates[0].map(([lng,lat])=>[lat,lng]); }
            else if(g.type==='MultiPolygon'){ ring=g.coordinates[0][0].map(([lng,lat])=>[lat,lng]); }
            else continue;
            const props=ft.properties||{};
            const name = detectName(props);
            const firm = detectFirm(props) || firmFilter || askFirmOnce();
            toAdd.push({ id: rid(), name, firm, coords:[ring], props });
          }
          features = toAdd.concat(features);
          save(LS_FEATURES, features);
          drawMap(); renderParcels(); renderFirms();
          if(toAdd[0]) map.setView(centerOf(toAdd[0].coords), 15);
        }catch(e){ alert('Fișier invalid (GeoJSON Poligon/MultiPoligon)'); }
      }; r.readAsText(f);
    });

    document.getElementById('export').addEventListener('click',()=>{
      const out={ type:'FeatureCollection', features: features.map(f=>({ type:'Feature', properties:Object.assign({}, f.props||{}, { name:f.name, firm:f.firm }), geometry:{ type:'Polygon', coordinates:[ f.coords[0].map(([lat,lng])=>[lng,lat]) ] } })) };
      const blob=new Blob([JSON.stringify(out,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='parcele_firme.geojson'; a.click();
    });

    // Helpers: name/firm detection
    function detectName(p){
      const keys = ['PARCELA','Parcela','parcela','name','Name','Nume','NUME','ID','id','Cod','COD'];
      for(const k of keys){ if(p[k]) return String(p[k]); }
      // fallback: try to find something like "84a" in any string field
      for(const k in p){ const v=p[k]; if(typeof v==='string'){ const m=v.match(/\b\d+[a-zA-Z]?\b/); if(m) return m[0]; } }
      return 'Parcelă';
    }
    function detectFirm(p){
      const val = Object.values(p).map(v=>String(v).toLowerCase());
      if(val.some(s=>s.includes('keresztes') || s.includes('emese'))) return 'Keresztes Emese';
      if(val.some(s=>s.includes('agroarn'))) return 'Agroarn';
      if(val.some(s=>s.includes('agrobaza') || s.includes('agrobaza keresztes'))) return 'Agrobaza';
      return null;
    }
    let askedFirm=null;
    function askFirmOnce(){
      if(askedFirm!==null) return askedFirm;
      const choice = prompt('Nu am găsit firma în fișier. Scrie una din: Keresztes Emese, Agroarn, Agrobaza');
      askedFirm = (FIRMS.includes(choice) ? choice : null);
      return askedFirm;
    }

    // Search
    document.getElementById('search').addEventListener('input',()=>{ drawMap(); renderParcels(); });

    // Utils
    function rid(){ try{ return crypto.randomUUID(); } catch { return 'id-'+Math.random().toString(36).slice(2,10); } }
    function escapeHtml(s){ return String(s).replace(/[&<>'"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

    // init
    renderFirms(); renderParcels(); drawMap();
  </script>

  <style>
    /* tooltip style to be readable */
    .leaflet-tooltip.parcel-label {
      background: rgba(255,255,255,.9);
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 2px 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,.08);
      font-size: 12px;
      color: #111827;
    }
  </style>
</body>
</html>
